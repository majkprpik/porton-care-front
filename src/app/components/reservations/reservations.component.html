<div class="reservations-container">
  <!-- Loading indicator -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading reservation data...</p>
  </div>

  <!-- Error message -->
  <div class="error-message" *ngIf="errorMessage">
    <p>{{ errorMessage }}</p>
    <button (click)="loadData()">Retry</button>
  </div>

  <!-- Main content wrapper with grid and tabs -->
  <div class="grid-with-tabs" *ngIf="!isLoading && !errorMessage">
    <!-- Feature hint tooltip -->
    <!-- <div class="feature-hint">
      <div class="hint-icon">üí°</div>
      <div class="hint-text">
        <strong>Tip:</strong> Click and drag across multiple days to create a multi-day reservation quickly.
      </div>
    </div> -->
    
    <!-- Year header -->
    <div class="year-header">
      <h1>{{ currentDate.getFullYear() }} Reservations</h1>
    </div>
    
    <!-- Reservations grid -->
    <div class="reservations-grid" [class.dragging]="isDragging">
      <div class="grid-scroll-container">
        <div class="grid-container">
          <!-- Combined Month and Day Header Row -->
          <div class="grid-header">
            <div class="grid-cell header-cell house-cell"></div>
            <ng-container *ngFor="let month of months">
              <ng-container *ngFor="let day of getMonthDays(month)">
                <div class="grid-cell day-header-cell day-cell">
                  {{ day }}.{{ getMonthNumber(month.name) }}
                </div>
              </ng-container>
            </ng-container>
          </div>
          
          <!-- House Rows with Reservation Cells -->
          <div class="grid-row" *ngFor="let house of filteredMobileHomes">
            <div class="grid-cell house-cell">
              <div class="house-name">{{ house.housename.split(' ')[1] }}</div>
            </div>
            
            <!-- Generate cells for each month/day combination -->
            <ng-container *ngFor="let month of months">
              <ng-container *ngFor="let day of getMonthDays(month)">
                <div 
                  class="grid-cell reservation-cell"
                  [class.has-reservation]="hasReservation(house.house_id, day + '.' + getMonthNumber(month.name))"
                  [class.drag-over]="isDraggedCell(house.house_id, day + '.' + getMonthNumber(month.name))"
                  [ngStyle]="getCellStyle(house.house_id, day + '.' + getMonthNumber(month.name))"
                  (click)="onCellClick(house.house_id, day + '.' + getMonthNumber(month.name), $event)"
                  (mousedown)="onCellMouseDown(house.house_id, day + '.' + getMonthNumber(month.name), $event)"
                  (mouseover)="onCellMouseOver(house.house_id, day + '.' + getMonthNumber(month.name))"
                  (mouseenter)="hasReservation(house.house_id, day + '.' + getMonthNumber(month.name)) && onReservationHover(getReservation(house.house_id, day + '.' + getMonthNumber(month.name)).reservationId)"
                  (mouseleave)="onReservationHover(null)"
                >
                  <ng-container *ngIf="hasReservation(house.house_id, day + '.' + getMonthNumber(month.name))">
                    <div class="reservation-content">
                      <ng-container *ngIf="getReservation(house.house_id, day + '.' + getMonthNumber(month.name))?.isFirstDay">
                        <div class="guest-name">{{ getReservation(house.house_id, day + '.' + getMonthNumber(month.name)).guest }}</div>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Excel-style tabs at bottom -->
    <div class="excel-tabs">
      <div 
        *ngFor="let type of houseTypes" 
        class="excel-tab" 
        [class.active]="currentHouseType === type"
        (click)="changeHouseType(type)"
      >
        {{ type }}
      </div>
    </div>
  </div>

  <!-- Reservation Details Popup -->
  <div class="reservation-popup" *ngIf="showPopup" [ngStyle]="popupPosition" (click)="onPopupClick($event)">
    <div class="popup-header">
      <h3>Reservation Details</h3>
      <button class="close-button" (click)="closePopup()">√ó</button>
    </div>
    
    <div class="popup-content" *ngIf="selectedReservation">
      <div class="popup-row">
        <strong>Guest:</strong> {{ selectedReservation.guest }}
      </div>
      <div class="popup-row">
        <strong>Phone:</strong> {{ selectedReservation.phone }}
      </div>
      <div class="popup-row">
        <strong>Period:</strong> {{ selectedReservation.startDay }} {{ getMonthName(selectedReservation.startMonth) }} - {{ selectedReservation.endDay }} {{ getMonthName(selectedReservation.endMonth) }}
      </div>
      <div class="popup-row">
        <strong>Adults:</strong> {{ selectedReservation.adults }}
      </div>
      <div class="popup-row">
        <strong>Children:</strong> {{ selectedReservation.children }}
      </div>
      <div class="popup-row" *ngIf="selectedReservation.extraBeds > 0">
        <strong>Extra Beds:</strong> {{ selectedReservation.extraBeds }}
      </div>
      <div class="popup-row" *ngIf="selectedReservation.pets > 0">
        <strong>Pets:</strong> {{ selectedReservation.pets }}
      </div>
      <div class="popup-row" *ngIf="selectedReservation.notes">
        <strong>Notes:</strong> {{ selectedReservation.notes }}
      </div>
      
      <div class="popup-actions">
        <button class="edit-button" (click)="editReservation()">
          <span class="action-icon">‚úèÔ∏è</span> Edit
        </button>
        <button class="delete-button" (click)="removeReservation()">
          <span class="action-icon">üóëÔ∏è</span> Remove
        </button>
      </div>
    </div>
  </div>

  <!-- New Reservation Popup -->
  <div class="new-reservation-popup" *ngIf="showNewReservationPopup" [ngStyle]="newReservationPopupPosition">
    <div class="popup-header">
      <h3>{{ selectedReservation ? 'Edit Reservation' : 'Create New Reservation' }}</h3>
      <button class="close-button" (click)="cancelNewReservation()">√ó</button>
    </div>
    
    <div class="popup-content">
      <!-- Selected date range indicator -->
      <div class="selected-range-info" *ngIf="pendingReservationRange">
        <span class="range-icon">üìÖ</span>
        <span class="range-text">
          Selected dates: <strong>{{ pendingReservationRange.startDay }} {{ getMonthName(pendingReservationRange.month) }}</strong> to <strong>{{ pendingReservationRange.endDay }} {{ getMonthName(pendingReservationRange.month) }}</strong>
          <span class="range-days">({{ pendingReservationRange.endDay - pendingReservationRange.startDay + 1 }} days)</span>
        </span>
      </div>
      
      <form (submit)="$event.preventDefault(); createNewReservation()">
        <div class="form-row-group">
          <div class="form-row">
            <label for="guest_name">Guest Name:</label>
            <input type="text" id="guest_name" [(ngModel)]="newReservation.guest_name" name="guest_name" required>
          </div>
          
          <div class="form-row">
            <label for="guest_phone">Phone:</label>
            <input type="tel" id="guest_phone" [(ngModel)]="newReservation.guest_phone" name="guest_phone">
          </div>
        </div>
        
        <div class="form-row-group">
          <div class="form-row">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" [(ngModel)]="newReservation.start_date" name="start_date" required (change)="onDateInputChange()">
          </div>
          
          <div class="form-row">
            <label for="end_date">End Date:</label>
            <input type="date" id="end_date" [(ngModel)]="newReservation.end_date" name="end_date" required (change)="onDateInputChange()">
          </div>
        </div>
        
        <div class="form-row number-inputs">
          <div class="number-field">
            <label for="adults">Adults:</label>
            <input type="number" id="adults" [(ngModel)]="newReservation.adults" name="adults" min="1" required>
          </div>
          
          <div class="number-field">
            <label for="children">Children:</label>
            <input type="number" id="children" [(ngModel)]="newReservation.children" name="children" min="0">
          </div>
        
          <div class="number-field">
            <label for="extraBeds">Extra Beds:</label>
            <input type="number" id="extraBeds" [(ngModel)]="newReservation.extraBeds" name="extraBeds" min="0">
          </div>
          
          <div class="number-field">
            <label for="pets">Pets:</label>
            <input type="number" id="pets" [(ngModel)]="newReservation.pets" name="pets" min="0">
          </div>
        </div>
        
        <div class="form-row">
          <label for="notes">Notes:</label>
          <textarea id="notes" [(ngModel)]="newReservation.notes" name="notes" rows="2"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="cancel-button" (click)="cancelNewReservation()">Cancel</button>
          <button type="submit" class="create-button">
            {{ selectedReservation ? 'Update Reservation' : 'Create Reservation' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
